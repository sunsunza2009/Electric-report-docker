{% extends 'base.html' %}
{% block title %}Energy Saving - Sensor Condition{% endblock %}
{% block css %}.text-unset{text-align: unset !important;}.swal2-input{color: #000;}{% endblock %}
{% block content %}
          <!-- Page Heading -->
          <h1 class="h3 mb-2 text-gray-800">Condition Managemnet</h1>
          <!-- DataTales Example -->
          <div class="card shadow mb-4">
            <div class="card-body">
              <button type="button" class="btn btn-success mb-3" id="new">Add</button>
              <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Name</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                </table>
              </div>
            </div>
          </div>
{% endblock %}
{% block js %}
<script>
  var roomlist = '';
  var Table = $('#dataTable').DataTable();
  $('#content').on('click', "#new, button[name='edit']" ,async function () {
    Swal.mixin({
      confirmButtonText: 'Next &rarr;',
      showCancelButton: true,
      progressSteps: ['1', '2'],
      cancelButtonColor: '#d33',
      width: '60rem',
      customClass: {
        content: 'text-unset text-white'
      }
    }).queue([
      {
        title: 'Please specify conditions.',
        html: '<div id="alert-builder-plugins"></div>',
        preConfirm: (res) => {
          var result = $('#alert-builder-plugins').queryBuilder('getRules');
          if (result && !$.isEmptyObject(result)) {
            return JSON.stringify(result, null);
          }else{
            return false;
          }
        }
      },
      {
        title:'Please specify a name.',
        input: 'text',
        confirmButtonText: 'Submit',
      }
    ]).then((result) => {
      if (result.value) {
        console.log(result.value)
        /*if(this.id != "new"){
          let data = JSON.parse(decodeURIComponent($(this).attr("data")))
          $.ajax({
            url: "{{ url_for('Private.rule_edit') }}",
            method: "POST",
            data: { }
          }).then(function(res){
            getRule()
            Swal.fire(
              'Edited!',
              'Rule has been edit.',
              'success'
            )
          })
          return
        }
        $.ajax({
          url: "{{ url_for('Private.rule_add') }}",
          method: "POST",
          data: { }
        }).then(function(res){
          getRule()
          Swal.fire(
            'Added!',
            'Rule has been Add.',
            'success'
          )
        })
        .catch(function (err) {
          console.log(err);
        });*/
      }
    })

   // var rules_plugins = { };
    $('#alert-builder-plugins').queryBuilder({
      plugins: [
        'sortable',
        'filter-description',
        'unique-filter',
        'bt-tooltip-errors',
        'bt-selectpicker',
        'bt-checkbox'
      ],
      operators: [
        { type: 'equal', optgroup: 'basic' },
        { type: 'not_equal', optgroup: 'basic' },
        { type: 'greater', optgroup: 'basic' },
        { type: 'greater_or_equal', optgroup: 'basic' },
        { type: 'less', optgroup: 'basic' },
        { type: 'less_or_equal', optgroup: 'basic' },
        { type: 'all_contain', optgroup: 'custom', nb_inputs: 1, multiple: true, apply_to: ['checkbox'] },
        { type: 'any_contain', optgroup: 'custom', nb_inputs: 1, multiple: true, apply_to: ['checkbox'] }],
      filters: [{
        id: 'type',
        label: 'Type',
        type: 'string',
        input: roomCheckBox,
        description: 'This filter uses Awesome Bootstrap Checkboxes',
        operators: ['all_contain', 'any_contain'],
        validation: {
          min: 1
        }
      },{
        id: 'dow',
        label: 'Day of Week',
        type: 'integer',
        input: 'checkbox',
        values: [
          'Sunday',
          'Monday',
          'Tuesday',
          'Wednesday',
          'Thursday',
          'Friday',
          'Saturday'
        ],
        validation: {
          min: 1
        },
        description: 'This filter uses Awesome Bootstrap Checkboxes',
        operators: ['any_contain'],
      },{
        id: 'room',
        label: 'Room',
        type: 'integer',
        input: 'checkbox',
        values: [
          'IF-4C01',
          'IF-4C02',
          'IF-11M280'
        ],
        validation: {
          min: 1
        },
        description: 'This filter uses Awesome Bootstrap Checkboxes',
        operators: ['any_contain'],
      },{
        id: 'rate',
        label: '24-hour clock',
        type: 'integer',
        validation: {
          min: 1,
          max: 24
        },
        plugin: 'slider',
        plugin_config: {
          min: 1,
          max: 24,
          value: 1
        },
        operators: ['equal','not_equal','greater', 'greater_or_equal','less', 'less_or_equal'],
        valueSetter: function(rule, value) {
          if (rule.operator.nb_inputs == 1) value = [value];
          rule.$el.find('.rule-value-container input').each(function(i) {
            $(this).slider('setValue', value[i] || 0);
          });
        },
        valueGetter: function(rule) {
          var value = [];
          rule.$el.find('.rule-value-container input').each(function() {
            value.push($(this).slider('getValue'));
          });
          return rule.operator.nb_inputs == 1 ? value[0] : value;
        }
      }],
      isInline:false,
      //rules: rules_plugins
    }).on("afterUpdateRuleFilter.queryBuilder", function() {
      $('.query-builder select').selectpicker();
    });

  });

  $('table').on('click', "button[name='del']" , function () {
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes',
    }).then((result) => {
      if (result.value) {
        $.ajax({
          url: "{{ url_for('Private.rule_del') }}",
          data:{id:$(this).attr("data-id")},
          method: "GET"
        }).then(function(res){
          getRule()
          Swal.fire(
            'Deleted!',
            'Your condition has been deleted.',
            'success'
          )
        })
        .catch(function (err) {
          console.log(err);
        });
      }
    })
  });

  var getRule = function(){
    $.ajax({
      url: "{{ url_for('Private.rule_view') }}",
      method: "GET"
    }).then(function(res){
      initTable(res)
    })
    .catch(function (err) {
      console.log(err);
    });
  };

  var initTable = function(data){
    Table.clear();
    data.forEach(function(elem){
      _rowType = "<table class=\"table\">"
      elem["type"].forEach(function(elem2){
        _rowType += "<tr><td>" + elem2["tname"] + "</td><td>" + (elem2["enabled"] == 1 ? "Enable" : "Disable") + "</td><td>" + (elem2["state"] == 1 ? "ON" : "OFF")  + "</td></tr>"
      })
      _rowType += "</table>"
      Table.row.add( [
            elem["ruid"],
            elem["rname"],
            _rowType,
            elem["st_time"] + " - " + elem["end_time"],
            "<button type=\"button\" class=\"btn btn-warning\" id=\"edit\" name=\"edit\" data=\""+encodeURIComponent(JSON.stringify(elem))+"\">Edit</button>\n" +
            "<button type=\"button\" class=\"btn btn-danger\" id=\"del\" name=\"del\" data-id=\""+elem["ruid"]+"\">Delete</button>"
        ] ).draw( false );
    })
  };

$( document ).ready(function() {
  $.ajax({
    url: "{{ url_for('Private.sensor_list') }}",
    method: "GET"
  }).then(function(res){
    res.forEach((elem)=>{
      if(roomlist.indexOf(elem["rname"]) == -1){
        let newOpt = $('<option></option>').attr('value', elem["rid"]).text(elem["rname"])
        roomlist += newOpt[0].outerHTML
      }
    })
  })
  .catch(function (err) {
    console.log(err);
  });
  getRule()
})

let vaildLen = function(value,rule){
  return value.length > 0
}

let roomCheckBox = function(){
  return '<div class="form-row ml-2 mt-1">\
            <div class="custom-control custom-checkbox custom-control-inline mt-2">\
              <input type="checkbox" name="" id="test" value="0" class="custom-control-input">\
              <label for="test" class="custom-control-label">Electric</label>\
            </div>\
            <div class="col">\
              <select class="form-control"><option>ON</option><option>OFF</option></select>\
            </div>\
          </div>\
          <div class="form-row ml-2 mt-1">\
            <div class="custom-control custom-checkbox custom-control-inline mt-2">\
              <input type="checkbox" name="" id="test2" value="0" class="custom-control-input">\
              <label for="test2" class="custom-control-label">Motion</label>\
            </div>\
            <div class="col">\
              <select class="form-control"><option>ON</option><option>OFF</option></select>\
            </div>\
          </div>'
};

</script>
{% endblock %}