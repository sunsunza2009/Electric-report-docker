{% extends 'base.html' %}
{% block title %}Energy Saving - Charts{% endblock %}
{% block css %}
    .selected{
      background-color: rgba(192,192,192,0.5);
    }
    tr[role="row"]:hover {
        cursor:pointer;
    }
{% endblock %}
{% block content %}

<h1 class="h3 mb-2 text-gray-800">Dashboard</h1>
<div class="row">
	<div class="col">
		<div class="card shadow mb-4">
			<div class="card-body">
				<form id="searchForm">
					<div class="form-row">
						<div class="col-md mb-3">
							<label for="sName">Sensor Name</label>
							<input type="text" class="form-control " id="sName" placeholder="Search...">
						</div>
					</div>
					<div class="form-row">
						<div class="col-md-6 mb-3">
							<label for="building">Building</label>
							<select class="custom-select" id="building">
								<option selected value="">All</option>

							</select>

						</div>
						<div class="col-md-3 mb-3">
							<label for="floor">Floor</label>
							<select class="custom-select" id="floor">
								<option selected value="">All</option>

							</select>
						</div>
						<div class="col-md-3 mb-3">
							<label for="room">Room</label>
							<select class="custom-select" id="room">
								<option selected value="">All</option>

							</select>
						</div>
						Sensor Type :
					</div>
					<div class="form-row">
						<div class="col-md-2 mb-3">
							<div class="custom-control custom-checkbox">
								<input type="checkbox" class="custom-control-input" id="Light" data-type="" checked
									value="Light" name="typeFilter">
								<label class="custom-control-label" for="Light">Light</label>
							</div>
						</div>
						<div class="col-md-2 mb-3">
							<div class="custom-control custom-checkbox">
								<input type="checkbox" class="custom-control-input" id="Electricity" data-type=""
									checked value="Electricity" name="typeFilter">
								<label class="custom-control-label" for="Electricity">Electricity</label>
							</div>
						</div>
						<div class="col-md mb-3">
							<div class="custom-control custom-checkbox">
								<input type="checkbox" class="custom-control-input" id="Air Conditioner" data-type=""
									checked value="Air Conditioner" name="typeFilter">
								<label class="custom-control-label" for="Air Conditioner">Air Conditioner</label>
							</div>
						</div>
					</div>

					<div class="form-row">
						<div class="col-md-8 mt-2">
							<button class="btn btn-primary mr-3" type="button" id="search">Search</button>
							<button class="btn btn-primary mr-3" type="button" id="addToDash">Add to Dashboard</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	<div class="col">
		<div class="card shadow mb-4">
			<div class="card-body">
				<button class="btn btn-outline-danger mb-2 float-right" id="clearRows">clear</button>
				<div class="table-responsive">
					<table class="table display compact" id="dashboard" width="100%" cellspacing="0">
						<thead>
							<tr>
								<th>type</th>
								<th>name</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<br>
<div class="row">
	<div class="col-2">
		<button class="btn btn-success" type="button" id="Bcompare">Compare</button>
		<button class="btn btn-danger" type="button" id="Bcombine">Combine</button>
		<button class="btn btn-warning" type="button" id="Bseparate">Separate</button>
	</div>
	<div class="col-2">
		<label>Time range:</label>
		<input type="text" name="datetimes" />
	</div>
	<div class="col-2">
		<label>Unit:</label>
		<select id="unit">
			<option value="15m">15minutes</option>
			<option value="30m">30mimutes</option>
			<option value="1h">1hour</option>
			<option value="12h" selected>12hours</option>
			<option value="1d">1day</option>
			<option value="7d">1week</option>
		</select>
		<button id="update" class="btn btn-outline-primary">update</button>
	</div>
	<div class="col-2">
		<button class="btn btn-outline-success" id="autoRefresh">auto update</button>
	</div>
</div>
<br>
<!-- Content Row -->
<br>
<br>
<center>
	<div id="dashGraph" class="bg-white">
		<button class="btn btn-outline-info float-right" id="fullscreen"><i class="fa fa-expand"
				aria-hidden="true"></i></button>
		<div id="compare"><br><br></div>
		<div id="combine"><br><br></div>
		<div id="separate"><br><br></div>

	</div>
</center>
<!-- /.container-fluid -->
{% endblock %}
{% block js %}
<script>
	let range;
	let startTime;
	let endTime;
	range = $('input[name="datetimes"]').daterangepicker({
		timePicker: true,
		startDate: moment().subtract(1, 'days'),
		endDate: moment(),
		locale: {
			format: 'M/DD hh:mm A'
		}
	});

	$('input[name="datetimes"]').on('apply.daterangepicker', function (ev, picker) {
		startTime = new Date(picker.startDate.format('YYYY-MM-DD hh:mm:ss')).getTime() * 1000000
		endTime = new Date(picker.endDate.format('YYYY-MM-DD hh:mm:ss')).getTime() * 1000000
	});



	var getRoomData = function () {
		$.ajax({
			type: 'GET',
			url: '{{ url_for("Private.all_room_list") }}',
			dataType: 'json',
			success: function (roomData) {
				let building = $('#building');
				let floor = $('#floor');
				let room = $('#room');
				$.each(roomData, function (key, entry) {
					building.append($('<option></option>').attr('value', entry.bid).text(entry
						.bname));
				})

				$(building).change(function () {
					floor.empty();
					floor.append('<option selected value="">All</option>');
					floor.prop('selectedIndex', 0);
					room.empty();
					room.append('<option selected value="">All</option>');
					room.prop('selectedIndex', 0);
					$.each(roomData, function (key, entry) {
						if (entry.bid == building.val()) {
							$.each(entry.floor, function (key, entry2) {
								floor.append($('<option></option>').attr('value',
									entry2.fid).text(entry2.fname));
							})
						}
					})
				});

				$(floor).change(function () {
					room.empty();
					room.append('<option selected value="">All</option>');
					room.prop('selectedIndex', 0);
					$.each(roomData, function (key, entry) {
						if (entry.bid == building.val()) {
							$.each(entry.floor, function (key, entry2) {
								if (entry2.fid == floor.val()) {
									$.each(entry2.room, function (key, entry3) {
										room.append($('<option></option>')
											.attr('value', entry3.rid)
											.text(entry3
												.rname));
									})
								}
							})
						}
					})
				});

			}
		});
	}

	getRoomData();

	var dashboardArray = [];
	var typeFilter = "Light|Electricity|Air Conditioner";
	$('input:checkbox').on('change', function () {
		typeFilter = $('input:checkbox[name="typeFilter"]:checked').map(
			function () {
				return this.value;
			}).get().join('|');

	});
	var dashboard = $('#dashboard').DataTable();
	var updateDashboard = function () {
		dashboard.destroy();
		dashboard = $('#dashboard').DataTable({
			data: dashboardArray,
			columns: [{
				data: 'type'
			}, {
				data: 'name'
			}],
			pageLength: 5,
			lengthMenu: [
				[5, 10, 20],
				[5, 10, 20]
			]
		});
	}
	updateDashboard();

	$('#clearRows').click(function () {
		dashboardArray = [];
		dashboard.rows().remove().draw(false);
	});

	function hasDup(value) {
		for (i = 0; i < dashboardArray.length; i++) {
			if (JSON.stringify(dashboardArray[i]) === JSON.stringify(value)) {
				return true
			}
		}
		return false
	}

	$("#addToDash").click(function () {
		if ($('#building').val() != "") {
			if ($('#floor').val() != "") {
				if ($('#room').val() != "") {
					roomToAdd = {
						'type': 'room',
						'id': $('#room').val(),
						'name': $("#room option:selected").html()
					};
					if (hasDup(roomToAdd) === false) {
						dashboardArray.push(roomToAdd);
					}
				} else {
					floorToAdd = {
						'type': 'floor',
						'id': $('#floor').val(),
						'name': $("#floor option:selected").html()
					};
					if (hasDup(floorToAdd) === false) {
						dashboardArray.push(floorToAdd);
					}
				}
			} else {
				buildingToAdd = {
					'type': 'building',
					'id': $('#building').val(),
					'name': $("#building option:selected").html()
				};
				if (hasDup(buildingToAdd) === false) {
					dashboardArray.push(buildingToAdd);
				}
			}
		} else {
			Swal.fire(
				'Cannot add to Dashboard',
				'Please select at least 1 item to add',
				'warning'
			)
		}
		updateDashboard();
	});

	$("#compare").hide();
	$("#combine").hide();
	$("#separate").hide();

	$("#Bcompare").click(function () {
		$("#compare").show();
		$("#combine").hide();
		$("#separate").hide();
	});
	$("#Bcombine").click(function () {
		$("#combine").show();
		$("#compare").hide();
		$("#separate").hide();
	});
	$("#Bseparate").click(function () {
		$("#separate").show();
		$("#combine").hide();
		$("#compare").hide();
	});

	$("#search").click(function () {
		Swal.fire({
			width: '60rem',
			title: 'Please select sensor to add to dashboard',
			html: '<div class="card shadow mb-4">\
    <div class="card-body">\
        <div class="table-responsive">\
            <table class="table table-bordered" id="sensor_list" width="100%" cellspacing="0">\
                <thead>\
                    <tr>\
                        <th>#</th>\
                        <th>Sensor Name</th>\
                        <th>Room</th>\
                        <th>Floor</th>\
                        <th>Building</th>\
                        <th>Type</th>\
                    </tr>\
                </thead>\
                <tbody>\
                </tbody>\
            </table>\
        </div>\
    </div>\
</div>',
			focusConfirm: false,
			showCancelButton: true,
			confirmButtonColor: '#3085d6',
			cancelButtonColor: '#d33',
			confirmButtonText: 'Select',
			onBeforeOpen: function () {
				sensors = $('#sensor_list').DataTable({
					ajax: {
						"url": "{{ url_for('Private.sensor_list') }}",
						"type": "GET",
						"dataSrc": "",
					},
					columns: [{
						data: 'sid'
					}, {
						data: 'sname'
					}, {
						data: 'rname'
					}, {
						data: 'fname'
					}, {
						data: 'bname'
					}, {
						data: 'tname'
					}]
				});

				sensors.columns(1).search($('#sName').val()).draw();

				if ($('#building').val() != "") {
					sensors.columns(4).search($("#building option:selected").html()).draw();
				}
				if ($('#floor').val() != "") {
					sensors.columns(3).search($("#floor option:selected").html()).draw();
				}
				if ($('#room').val() != "") {
					sensors.columns(2).search($("#room option:selected").html()).draw();
				}

				sensors.column(5).search(typeFilter, true, false, false).draw(false);

				$('#sensor_list tbody').on('click', 'tr', function () {
					$(this).toggleClass('selected');
				});
			},
			preConfirm: () => {
				data = sensors.rows('.selected').data();
				$.each(data, function (index, value) {
					sensorToAdd = {
						'type': 'sensor',
						'id': value.sid,
						'name': value.sname
					}
					if (hasDup(sensorToAdd) === false) {
						dashboardArray.push(sensorToAdd);
					}
				});
				updateDashboard();
			}
		});
	});

	var color = Chart.helpers.color;
	var cfg = {
		data: {
			datasets: [{
				label: 'tmp',
				backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
				borderColor: window.chartColors.blue,
				data: [{
					t: 000000000000,
					y: "0"
				}],
				type: 'line',
				pointRadius: 0,
				fill: false,
				lineTension: 0,
				borderWidth: 2
			}]
		},
		options: {
			animation: {
				duration: 0
			},
			scales: {
				xAxes: [{
					type: 'time',
					distribution: 'series',
					offset: true,
					gridLines: {
						display: false,
						drawBorder: false
					},
					ticks: {
						major: {
							enabled: true,
							fontStyle: 'bold'
						},
						source: 'data',
						autoSkip: true,
						autoSkipPadding: 75,
						maxRotation: 0,
						sampleSize: 100
					}
				}],
				yAxes: [{
					gridLines: {
						color: "rgb(234, 236, 244)",
						zeroLineColor: "rgb(234, 236, 244)",
						drawBorder: false,
						borderDash: [2],
						zeroLineBorderDash: [2]
					},
					scaleLabel: {
						display: true,
						labelString: 'Watt'
					}
				}]
			},
			pan: {
				enabled: true,
				mode: "x",
				speed: 100,
				threshold: 100
			},
			pan: {
				enabled: true,
				mode: "y",
				speed: 100,
				threshold: 100
			},
			zoom: {
				enabled: true,
				drag: false,
				mode: "x",
			},
			zoom: {
				enabled: true,
				drag: false,
				mode: "y",
			},
			tooltips: {
				intersect: false,
				mode: 'index',
				callbacks: {
					label: function (tooltipItem, myData) {
						var label = myData.datasets[tooltipItem.datasetIndex].label || '';
						if (label) {
							label += ': ';
						}
						label += parseFloat(tooltipItem.value).toFixed(2);
						return label;
					}
				}
			}
		}
	};

	let colorNames = Object.keys(window.chartColors);
	let compareChart = [];
	let combineChart = [];
	let separateChart = [];

	function clearChart() {
		$.each(compareChart, function (index, value) {
			value.destroy()
		});
		$.each(combineChart, function (index, value) {
			value.destroy()
		});
		$.each(separateChart, function (index, value) {
			value.destroy()
		});
		compareChart = [];
		combineChart = [];
		separateChart = [];
		jQuery('#compare div').html('');
		jQuery('#combine div').html('');
		jQuery('#separate div').html('');
	}

	function loadCompare(data) {

		$.each(["volt", "amp", "watt"], function (index, value) {
			var divChart = "<div style=\"width:1000px\"><canvas id=\"compare" + value + "\"></canvas></div>";
			$("#compare").append(divChart);
			var ctxTmp = document.getElementById('compare' + value).getContext('2d');
			ctxTmp.canvas.width = 1000;
			ctxTmp.canvas.height = 300;
			var cfgTmp = JSON.parse(JSON.stringify(cfg));
			cfgTmp.options.scales.yAxes[0].scaleLabel.labelString = value
			var chart = new Chart(ctxTmp, cfgTmp);
			compareChart.push(chart);
		});
		$.each(data, function (index, value) {
			var VAW = [value.volt, value.amp, value.watt];
			$.each(VAW, function (i, v) {
				var colorName = colorNames[compareChart[i].config.data.datasets.length % colorNames
				.length];
				var newColor = window.chartColors[colorName];
				var newDataset = {
					label: value.name,
					backgroundColor: newColor,
					borderColor: newColor,
					data: v,
					type: 'line',
					pointRadius: 0,
					fill: false,
					lineTension: 0,
					borderWidth: 2
				};
				compareChart[i].config.data.datasets.push(newDataset);
			});
		});
		$.each(compareChart, function (index, value) {
			value.config.data.datasets.splice(0, 1);
			value.update();
		});
	}

	function loadSeparate(data) {
		$.each(data, function (index, value) {
			var VAW = [value.volt, value.amp, value.watt];
			$("#separate").append("<div class=\"row\" id=\"row" + index + "\">");
			$.each(VAW, function (i, v) {
				var x;
				if (i == 0) x = "volt";
				if (i == 1) x = "amp";
				if (i == 2) x = "watt";
				var divChart = "<div class=\"col-4\"><canvas id=\"separate-" + value.name + "-" + x +
					"\"></canvas></div>"
				$("#row" + index).append(divChart);
				var ctxTmp = document.getElementById("separate" + "-" + value.name + "-" + x).getContext(
					'2d');
				var cfgTmp = JSON.parse(JSON.stringify(cfg));
				cfgTmp.options.scales.yAxes[0].scaleLabel.labelString = x
				var colorName = colorNames[cfgTmp.data.datasets.length % colorNames.length + index];
				var newColor = window.chartColors[colorName];
				var chart = new Chart(ctxTmp, cfgTmp);
				separateChart.push(chart);
				var newDataset = {
					label: value.name,
					backgroundColor: newColor,
					borderColor: newColor,
					data: v,
					type: 'line',
					pointRadius: 0,
					fill: false,
					lineTension: 0,
					borderWidth: 2
				};
				chart.config.data.datasets.push(newDataset);
				chart.config.data.datasets.splice(0, 1);
				chart.update();
			});
		});
	}

	function loadCombine(data) {
		var VAW = [data.volt, data.amp, data.watt];
		$.each(["volt", "amp", "watt"], function (i, v) {
			var divChart = "<div style=\"width:1000px\"><canvas id=\"combine" + v + "\"></canvas></div>";
			$("#combine").append(divChart);
			var ctxTmp = document.getElementById('combine' + v).getContext('2d');
			ctxTmp.canvas.width = 1000;
			ctxTmp.canvas.height = 300;
			var cfgTmp = JSON.parse(JSON.stringify(cfg));
			var chart = new Chart(ctxTmp, cfgTmp);
			combineChart.push(chart);
		});
		$.each(VAW, function (i, v) {
			var colorName = colorNames[i % colorNames.length];
			var newColor = window.chartColors[colorName];
			var newDataset = {
				label: data.name,
				backgroundColor: newColor,
				borderColor: newColor,
				data: v,
				type: 'line',
				pointRadius: 0,
				fill: false,
				lineTension: 0,
				borderWidth: 2
			};
			combineChart[i].config.data.datasets.push(newDataset);
		});
		$.each(combineChart, function (i, v) {
			v.config.data.datasets.splice(0, 1);
			v.update();
		});
	}

	function getAndLoad() {
		clearChart();
		
		if(startTime==undefined){
			startTime= new Date($('input[name="datetimes"]').data('daterangepicker').startDate).getTime()*1000000;
			endTime= new Date($('input[name="datetimes"]').data('daterangepicker').endDate).getTime()*1000000;
		}
		console.log(startTime);
		console.log(endTime);
		console.log(dashboardArray);
		$.ajax({
				url: "{{ url_for('Private.dashboard_list') }}",
				method: "POST",
				data: {
					data: JSON.stringify(dashboardArray),
					unit: $("#unit").val(),
					startTime: startTime,
					endTime: endTime
				}
			}).then(function (res) {
				loadSeparate(res);
				loadCompare(res);
				loadCombine(res);
				console.log(res);
			})
			.catch(function (err) {
				console.log(err);
			});
	}

	document.getElementById('update').addEventListener('click', function () {
		getAndLoad();
	});

	let checkFullScreen = false;
	let checkRefresh = false;
	let timerId;

	$('#fullscreen').click(function () {
		if (checkFullScreen == false) {
			$('#dashGraph').css({
				position: 'fixed',
				top: 0,
				right: 0,
				bottom: 0,
				left: 0,
				zIndex: 999
			});
			checkFullScreen = true;
		} else {
			$('#dashGraph').css({
				position: 'static',
				top: 'auto',
				right: 'auto',
				bottom: 'auto',
				left: 'auto',
				zIndex: 'auto'
			});
			checkFullScreen = false;
		}
	});

	$('#autoRefresh').click(function () {
		if (checkRefresh == false) {
			$(this).removeClass('btn-outline-success').addClass('btn-outline-danger');
			getAndLoad()
			timerId = setInterval(() => {
				getAndLoad();
			}, 900000);
			checkRefresh = true;
		} else {
			$(this).removeClass('btn-outline-danger').addClass('btn-outline-success');
			clearInterval(timerId);
			checkRefresh = false;
			console.log("cancel interval")
		}
	});
</script>
{% endblock %}